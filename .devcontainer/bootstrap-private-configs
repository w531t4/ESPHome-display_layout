#!/usr/bin/env bash
# SPDX-FileCopyrightText: 2025 Aaron White <w531t4@gmail.com>
# SPDX-License-Identifier: MIT
set -euo pipefail

: "${ESPHOME_HOME_GIT_URL:=}"
dest="/workspaces/ESPHome-display_layout/config"

if [[ -z "${ESPHOME_HOME_GIT_URL}" ]]; then
    echo "No private repo configured (ESPHOME_HOME_GIT_URL not set). Skipping."
    exit 0
fi

if [[ -d "${dest}/.git" ]]; then
    echo "Updating private repo in ${dest}..."
    git -C "${dest}" fetch --all --prune
    git -C "${dest}" pull --ff-only
else
    rm -f ${dest}
    echo "Cloning private repo into ${dest}..."
    git clone --depth=1 "${ESPHOME_HOME_GIT_URL}" "${dest}"
fi

ln -sfnT /workspaces/ESPHome-display_layout/components ${dest}/components
ln -sf /workspaces/ESPHome-display_layout/secrets.yaml ${dest}/secrets.yaml
